# DLBuildMenu: параметры и шаблоны
>Сниппет вывода меню **DLBuildMenu**, основанный на _DocLister_, предоставляет мощные инструменты создания меню сайта на MODx Evo. Но многие, даже опытные, MODx-юзеры не применяют DLBuildMenu &mdash; не в последнюю очередь из-за _отсутствия документации_. Восполняю этот пробел.

## Краткое описание
**DLBuildMenu** &mdash; сниппет для **вывода меню** сайта на MODx Evolution. Построен на основе ДокЛистера, по сути это сниппет-обертка с вызовом DocLister внутри &mdash; поэтому в нём можно использовать практически все параметры и фишки самого DocLister.

Применяя _prepare_, мы получаем неограниченные возможности подготовки данных. А развитая _система шаблонизации_ ДокЛистер, дополненная в DLBuildMenu новыми параметрами, даёт в руки, на мой взгляд, даже чрезмерно богатый инструментарий.

**Разработчик:** :bust_in_silhouette: [Agel_Nash](https://github.com/AgelxNash)


### :pushpin: Зависимости и требования

- Для работы DLBuildMenu у вас должен быть установлен _DocLister_ (есть в последних релизах MODx Evo _по умолчанию_).
- Требуется PHP не ниже _версии 5.4_ (в новых версиях Evo CMS лучше использовать _версию 5.6_ и выше).




### :pushpin: Установка

- DLBuildMenu входит _по умолчанию_ во все новые версии Evo CMS, начиная со сборки MODx Evo 1.2.1-d9.1.2 от 21.03.2017.
- На более старых сборках для его установки нужно _установить_ или _переустановить_ ДокЛистер из Extras, при этом&nbsp;нужно, чтобы DLBuildMenu был&nbsp;_отмечен_&nbsp;галочкой в списке при установке.




### :pushpin: Файлы

- assets/snippets/DocLister/snippet.DLBuildMenu.php
- assets/snippets/DocLister/lib/DLFixedPrepare.class.php (метод buildMenu)




### :pushpin: Преимущества DLBuildMenu

- есть возможность применения _prepare_&nbsp;для обработки данных перед выводом.
- _богатый выбор_ способов задания шаблонов, в том числе _инлайн-шаблоны_.
- _сортировка_ по TV-параметрам с приведением к нужному типу.
- может делать _фильтрацию_ по TV-параметрам.
- можно придумывать и задавать _собственные_ параметры и обрабатывать их в prepare.

>Кроме того, в DLBuildMenu работают и _другие фишки_ из арсенала ДокЛистер, описывать которые здесь не стану, для этого нужно изучать сам DL.


## Параметры
### :pushpin: Базовые параметры
#### :paperclip: &amp;idType (hardcoded)
Тип выборки аналогично DocLister.

**Возможные значения:**&nbsp;`parents`

**Примечание:**&nbsp;значение параметра _&amp;idType_ жестко записано в коде как _parents_.

#### :paperclip: &amp;parents
Родительская (начальная) папка.

**Возможные значения:**&nbsp;_ID_ родителя, либо список _ID_ родителей через запятую.

**Значение по умолчанию:**&nbsp;`0`

**Примечание:** Обратите внимание, что в DLBuildMenu значение _&amp;parents_ по умолчанию равно _0_, что означает &laquo;выводить начиная с корня сайта&raquo;. Это отличается от дефолтного значения _&amp;parents_ параметра в ДокЛистере.

#### :paperclip: &amp;currentDepth
Исходный уровень вложенности (глубина).

**Возможные значения:** целое число от _1_ и больше.

**Значение по умолчанию:** `1`

#### :paperclip: &amp;maxDepth
Макс. глубина

**Возможные значения:** целое число от 1 и больше.

**Значение по умолчанию:** `5`

#### :paperclip: &amp;BeforePrepare и&nbsp;&amp;AfterPrepare
Обработка данных через prepare аналогично DocLister.

**Возможные значения:**&nbsp;задаются по правилам ДокЛистера. Могут быть списком имен сниппетов и вызовов методов ренее загруженных классов, либо анонимной функцией.

**Примечание:** для prepare в DLBuildMenu уже имеется встроенный обязательный вызов _DLFixedPrepare::buildMenu_. Обработчики из _&amp;BeforePrepare_ вызываются перед встроенным, из _&amp;AfterPrepare_ - после встроенного вызова.

#### :paperclip: &amp;activeClass
CSS-класс активного (текущего) пункта меню и его родительских элементов всех уровней.

**Возможные значиения:** Имя CSS-класса, или несколько имён CSS-классов, заданные как в HTML-теге (через пробел).

**Значение по умолчанию:**&nbsp;`active`

**Примечание:**&nbsp;этот CSS-класс и &nbsp;этот параметр существуют в дополнение к уже имеющимся в ДокЛистере классам _first_, _last_, _odd_, _even_ и _current_&nbsp;и соответствующим параметрам для них (см. документацию по DocLIster).

### :pushpin: Параметры условий выборки
#### :paperclip: &amp;addWhereList
Условия выборки документов для всех уровней.

**Возможные значения:** задаются как в DocLister (по правилам MySQL для условия WHERE).

**Значение по умолчанию:**&nbsp;`c.hidemenu = 0`

#### :paperclip: &amp;addWhereListN
Условия выборки документов N-го уровня, для соответствующих уровней&nbsp;_&amp;addWhereListN_&nbsp;имеет приоритет над _&amp;addWhereList_.

**Возможные значения:** задаются по правилам MySQL для условия WHERE.

**Значение по умолчанию:** нет

**Примечание:** Если _&amp;addWhereListN_ не задан, для всех уровней используется _&amp;addWhereList_.

### :pushpin: Параметры сортировки
#### :paperclip: &amp;orderBy
Условия сортировки документов всех уровней

**Возможные значения:** задаются как в DocLister (по правилам MySQL для ORDER BY).

**Значение по умолчанию:** &nbsp;`menuindex ASC, id ASC`

#### :paperclip: &amp;orderByN
Условия сортировки документов N-го уровня вложенности, для соответствующих уровней&nbsp;_&amp;orderBy_&nbsp;имеет приоритет над _&amp;orderBy_.

**Возможные значения:** задаются по правилам MySQL для ORDER BY.

**Значение по умолчанию:** нет

**Примечание:**&nbsp;Если _&amp;orderByN_&nbsp;не задан, для всех уровней используется _&amp;orderBy_.

### :pushpin: Параметр &laquo;список TV&raquo;
#### :paperclip: &amp;tvList
Список TV-параметров, которые участвуют в выборке (как в DocLister).

**Возможные значения:** список имён TV-параметров через запятую.

**Значение по умолчанию:**&nbsp;нет

#### :paperclip: &amp;tvListN
Список TV-параметров в выборке для N-го уровня вложенности, для соответствующих уровней&nbsp;_&amp;tvListN_&nbsp;имеет приоритет над&nbsp;_&amp;tvList_.

**Возможные значения:** список имён TV-параметров через запятую.

**Значение по умолчанию:** пусто.

**Примечание:**&nbsp;Если _&amp;tvListN_ не задан, для всех уровней используется _&amp;tvList_.

## Шаблоны
Шаблоны DLBuildMenu задаются по правилам DL, то есть&nbsp;могут быть и _инлайн-шаблонами_, и&nbsp;_именами чанков_,&nbsp;или загружаться из _файла_,&nbsp;из _документа_ MODx,&nbsp;из _конфига_,&nbsp;из _глобального плейсхолдера_.

### :pushpin: Шаблоны-обёртки
#### :paperclip: &amp;TplMainOwner
Основной шаблон-обертка (для уровня глубины _1_).

**Значение по умолчанию:**

```phtml
@CODE:<ul id="nav" class="menu level-1">[+dl.wrap+]</ul>
```
**Примечание:**&nbsp;у вас должен быть задан шаблон _&amp;TplMainOwner_или _&amp;TplOwner1_, иначе будет использовано дефолтное значение шаблона&nbsp;_&amp;TplMainOwner_.

#### :paperclip: &amp;TplSubOwner
Шаблон-обертка для вложенных уровней (для субменю).

**Значение по умолчанию:**

```phtml
@CODE:<ul class="sub-menu level-[+dl.currentDepth+]">[+dl.wrap+]</ul>
```

**Примечание:**&nbsp;для вывода N-уровневого меню у вас в дополнение к основной обёртке должен быть задан по крайней мере&nbsp;_&amp;TplSubOwner_&nbsp;и/или шаблоны&nbsp;_&amp;TplOwnerN_. Иначе будет использовано дефолтное значение&nbsp;_&amp;TplSubOwner_.

#### :paperclip: &amp;TplOwnerN 
Шаблон-обертка для субменю N-го уровня вложенности, для соответствующих уровней&nbsp;_&amp;TplOwnerN_&nbsp;имеет приоритет над _&amp;TplMainOwner_ и _&amp;TplSubOwner_&nbsp;(см. Примечание).

**Значение по умолчанию:** нет

**Примечание:**&nbsp;Если заданы и _&amp;TplOwner1_, и _&amp;TplMainOwner_, то будет использован _&amp;TplOwner1_. &nbsp;Если заданы и&nbsp;_&amp;TplOwner2_&nbsp;и _&amp;TplSubOwner_, то для уровня 2 будет использован _&amp;TplOwner2_, а для уровней начиная с 3-го &mdash;&nbsp;_&amp;TplSubOwner_.

### :pushpin: Шаблоны пункта меню
#### :paperclip: &amp;TplOneItem
Основной шаблон для каждого пункта меню всех уровней.

**Значение по умолчанию:**

```phtml
@CODE:<li id="menu-item-[+id+]" class="menu-item [+dl.class+]">
   <a href="[+url+]" title="[+e.title+]">[+title+]</a>
   [+dl.submenu+]
</li>
```

**Примечание:**&nbsp;у вас должны быть заданы все нужные вам шаблоны пунктов меню, по крайней мере _&amp;TplOneItem_. Иначе для пунктов, у которых шаблон не определен вами, будет использовано дефолтное значение _&amp;TplOneItem_.

#### :paperclip: &amp;TplDepthN
Шаблон пункта меню вложенности N, для соответствующих уровней&nbsp;_&amp;TplDepthN_&nbsp;имеет приоритет над _&amp;TplOneItem_.

**Значение по умолчанию:** нет

**Примечание:**&nbsp;Например, если задан _&amp;TplDepth3_, он заменит собой шаблон _&amp;TplOneItem_ на 3-м уровне вложенности.

### :pushpin: Шаблоны пункта без дочерних элементов
#### :paperclip: &amp;noChildrenRowTPL
Основной шаблон пункта меню без дочерних элементов для всех уровней.

**Значение по умолчанию:**&nbsp;нет

#### :paperclip: &amp;TplNoChildrenDepthN
Шаблон пункта меню без дочерних элементов&nbsp;вложенности N. Для соответствующих уровней _&amp;TplNoChildrenDepthN_&nbsp;имеет приоритет над _&amp;noChildrenRowTpl_.

**Значение по умолчанию:** нет

**Примечание:** если для пункта меню не задан ни&nbsp;_&amp;noChildrenRowTPL_, ни&nbsp;_&amp;TplNoChildrenDepthN_, то в качестве шаблона для &laquo;бездетных&raquo; пунктов будет использован шаблон, заданный вами в других параметрах (_&amp;TplOneItem_ или _&amp;TplDepthN_).

### :pushpin: Шаблоны текущего пункта
#### :paperclip: &amp;TplCurrent
Шаблон текущего пункта меню с дочерними, имеет приоритет перед всеми шаблонами пунктов меню, кроме&nbsp;_&amp;TplCurrentN_.

**Значение по умолчанию:** нет

#### :paperclip: &amp;TplCurrentN
Шаблон текущего пункта меню вложенности N с дочерними&nbsp;, для N-го уровня шаблон&nbsp;_&amp;TplCurrentN_&nbsp;имеет приоритет перед всеми шаблонами пунктов меню&nbsp;с дочерними, включая _&amp;TplCurrent_.

**Значение по умолчанию:** нет.

#### :paperclip: &amp;TplCurrentNoChildrenN
Шаблон текущего пункта меню без дочерних элементов, где N &mdash; номер уровня вложенности. Для уровня N имеет приоритет перед любыми другими шаблонами &laquo;бездетных&raquo; пунктов меню.

**Значение по умолчанию:** нет.

## Плейсхолдеры
### :pushpin: Основные плейсхолдеры
#### :paperclip: [+dl.wrap+]
С его помощью в шаблон-обёртку подставляется сформированный HTML-код меню/субменю для вывода.

**Примечание:** используется только для шаблонов-обёрток&nbsp;_&amp;TplMainOwner,&nbsp;&amp;TplSubOwner_&nbsp;и&nbsp;_&amp;TplOwnerN_.

#### :paperclip: [+dl.submenu+]
Сюда подставляется сформированный HTML-код субменю вместе с шаблоном-обёрткой.

**Примечание:** используется для шаблонов пункта меню, как не текущих, так и текущих.

#### :paperclip: [+dl.currentDepth+]
Текущий уровень вложенности (текущая глубина).

**Примечание:** обратите внимание, что отсчёт текущего уровня вложенности начинается с _1_.

#### :paperclip: [+dl.class+]
Работает так же, как и в DocLister, автоматически добавляя классы&nbsp;last, first, current, even, odd соответственно для последнего, первого, текущего, четного и нечетного пункта. Кроме того, добавляет класс из параметра _&amp;activeClass_&nbsp;для _текущего_ элемента и его&nbsp;_родительских_ элементов всех уровней.

**Примечание:** классы&nbsp;_last_,&nbsp;_first_,&nbsp;_current_, _even_, _odd_ и _active_ могут быть переопределены в параметрах _&amp;__lastClass_, _&amp;currentClass_, _&amp;firstClass_, _&amp;evenClass_, _&amp;oddClass_ и _&amp;activeClass_.

#### :paperclip: [+url+]
_УРЛ_ ресурса аналогично ДокЛистеру. 

#### :paperclip: [+e.title+]
Экранированное значение _menutitle_ или _pagetitle_ (если _menutitle_ пуст) аналогично Доклистеру.

#### :paperclip: [+id+]
_ID_ ресурса аналогично ДокЛистеру.

### :pushpin: Другие плейсхолдеры из DocLister
Вы можете использовать и другие плейсхолдеры ДокЛистера, устанавливаемые контроллером _site_content_ и различными _экстендерами_.

Например, плейсхолдеры вида&nbsp;_[+tvPrefix.tvName+]_, плейсхолдеры экранированных значений вида _[+e.fieldName+]_ (где _fieldName_ - это имя поля таблицы _site_content_), _[+date+]_ и другие (см. документацию к DocLister).

## Шпаргалка по приоритетам шаблонов
Система шаблонов DLBuildMenu действительно очень гибкая, но к ней нужно привыкнуть. Для упрощения задачи ниже привожу cheatsheet (шпаргалку) по приоритетам шаблонов.

В левой колонке перечислены _типы элементов_ меню, а справа от каждого элемента идут применяемые для него _шаблоны_ в порядке _убывания_ приоритета.

|Тип&nbsp;элемента&nbsp;меню|Высший&nbsp;приоритет|Приоритет&nbsp;1|Приоритет 2|Приоритет&nbsp;3|Приоритет&nbsp;4|Приоритет&nbsp;5|
|---|---|---|---|---|---|---|
|Обёртка для всего меню (уровень 1)|&amp;TplOwner1|&amp;TplMainOwner|дефолтное значение&nbsp;&amp;TplMainOwner| | | |
|Обёртка для суб-меню (уровень N равен 2 и более)|&amp;TplOwnerN|&amp;TplSubOwner|дефолтное значение&nbsp;&amp;TplSubOwner| | | |			
|Не текущий пункт меню с дочерними (любой уровень N)|&amp;TplDepthN|&amp;TplOneItem|дефолтное значение&nbsp;&amp;TplOneItem| | | |			
|Не текущий пункт меню без дочерних (любой уровень N)|&amp;TplNoChildrenDepthN|&amp;noChildrenRowTPL|&amp;TplDepthN|&amp;TplOneItem|дефолтное значение&nbsp;&amp;TplOneItem| |			
|Текущий пункт меню с дочерними&nbsp;(любой уровень N)|&amp;TplCurrentN|&amp;TplCurrent|&amp;TplDepthN|&amp;TplOneItem|дефолтное значение&nbsp;&amp;TplOneItem| |			
|Текущий пункт меню без дочерних&nbsp;(любой уровень N)|&amp;TplCurrentNoChildrenN|&amp;TplNoChildrenDepthN|&amp;noChildrenRowTPL|&amp;TplDepthN|&amp;TplOneItem|дефолтное значение&nbsp;&amp;TplOneItem| 
			
Анализ исходников и написание доков DLBuildMenu: :bust_in_silhouette: [Aharito](http://aharito.ru/modx-evolution/dlbuildmenu-parametry-i-shablony)

